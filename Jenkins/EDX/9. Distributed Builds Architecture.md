# 9. Distributed Builds Architecture

# Chapter Overview

In this chapter, we will go over the distributed builds architecture and explain how you can scale your Jenkins build infrastructure.

---

# Learning Objectives

By the end of this chapter, you should be able to:

* Explain what the distributed builds are.
* Understand terminology related to the distributed builds.
* Set up a distributed build architecture.

---

# Why Distributed Build Architecture?

Up until now, we have run all the builds on the Jenkins Controller. So far it worked well for us. However, what if you need to run hundreds of builds every day? Well, you can try scaling your Jenkins Controller vertically by adding more resources (CPU, memory, etc), but you will eventually cap out of resources as you can scale a server vertically only up to a certain point.

The next thing that probably comes to your mind is adding more Jenkins Controllers. There are two major issues with this approach. First, it is going to create an administrative overhead to configure and keep track of all the Jenkins Controllers, and their corresponding builds, configurations, etc. Secondly, you may be developing applications that need to be supported on a variety of OS platforms, and you may need to run builds on various platforms. For instance, consider a situation when your application needs to be built and tested on Linux, Windows and MacOS. You won’t be able to achieve this because each Jenkins Controller is tied to a specific operating system.

Besides scaling, there is also a major security flaw associated with running your builds on the Jenkins Controllers. All Jenkins projects run with administrator privileges, and a malicious actor can potentially access or delete any private information compromising the security of your data.

The solution to the above problems is a distributed build architecture that allows you to have a single Jenkins Controller and leverage additional servers to perform the builds.

---

# Distributed Builds Terminology

Before we deep dive into distributed build architecture, let’s quickly review some terminology related to it.

* Controller: A machine where Jenkins is installed. It centrally stores all the configurations, loads plugins, and renders the Jenkins UI.
* Agent: A machine that connects to the Jenkins master and performs various operations as directed by the Jenkins Controller.
* Node: A machine that can allocate an executor and run Jenkins projects. Examples are Jenkins Controller and Agents. You will notice that nodes and agents are sometimes used synonymously.
* Executor: A Jenkins executor is one of the basic building blocks which allows a build to run on a node. You can configure more than one executor for every node. The number of executors is set based on the number of CPUs, IO performance and other hardware characteristics of a node and the type of builds you have configured to run. The number of executors determines the number of concurrent builds that can be run at any given point in time. It is Jenkins security best practice to set the number of executors to 0 on the Jenkins Controller, and not run any builds on it.

---

# Distributed Builds Architecture

In a distributed environment, all the Jenkins projects are configured centrally on the Jenkins Controller. The Jenkins Controller accepts all the requests for builds and manages the build environment, but offloads the bulk of work (execution of the builds) to the configured agents.

There are many advantages to this approach:

* It allows you to run builds for multiple OS platforms. For example, if you need to run a build on Windows platform, all you need to do is add a new Windows agent and connect it to your Jenkins Controller.
* It lets you scale your build infrastructure on demand by adding more build agents.
* It helps you mitigate security risk by restricting the information that an agent can request from the Jenkins Controller.

![image](https://user-images.githubusercontent.com/107522496/216060360-5a087842-3955-4b6c-adf5-5b41b7c3e653.png)
Distributed Builds Architecture


Please note that there are some requirements for this setup.

The Jenkins Controller needs to be able to communicate with the agent to offload the work of building the project. The agent executes all the tasks, and passes information (artifacts, build log, etc.) back to the Jenkins Controller which essentially requires a bi-directional communication between the Jenkins Controller and the agents.

All Jenkins agents require Java to be installed as there is a **slave.jar** file that needs to be run on all the agents. The Java version of the agent must be the same as the Java version installed on the Jenkins Controller.

The **slave.jar** file is located at `<Your Jenkins URL>/jnlpJars/slave.jar`.

Other than these requirements, there is no need for a shared file system, a shared subnet, etc.

 
---
  
# Connect a Build Agent

To connect a new Jenkins agent, you will need to navigate to _Dashboard > Manage Jenkins > Manage Nodes and Clouds_.

![image](https://user-images.githubusercontent.com/107522496/216061243-8e157ca2-c46b-4946-bbd0-dfd5c247dbfe.png)

Next, select New Node.

![image](https://user-images.githubusercontent.com/107522496/216061552-d96eea0b-888d-4ef8-9b48-61940dda3869.png)

Enter Node name, select Permanent Agent and click OK to proceed to the configuration screen.

![image](https://user-images.githubusercontent.com/107522496/216061627-31c4960a-3b18-48b7-a4b6-b9ee70adfe24.png)

---

# Configure a Build Agent

On the configuration screen, you are required to enter the following:

* Description: A meaningful description of the agent.
* Number of executors: Set this number based on the CPU cores on the agent.
* Remote root directory: An absolute path to a root directory on the agent. This directory will be used as a temporary root directory for building projects.

---

# Configure a Build Agent: Labels

Labels are used to group multiple agents into one logical group. For example, if you need to run builds on a Linux agent, you can assign each Linux agent a label called "linux". You can also use multiple labels for each agent. For example, a Linux agent that also runs Ruby builds can have two labels, "linux" and "ruby". Be sure to not use special characters for label names.

How do we use these labels in Jenkins projects? Let's see.

### For Freestyle Projects

Check the toggle for _Restrict where this project can be run under the General_ section, then enter the label name for the _Label Expression_.

![image](https://user-images.githubusercontent.com/107522496/216062023-469b347f-8a58-48cb-85de-13871dedd6e2.png)


### For Pipeline Projects

Bring up the Pipeline editor for your Pipeline project. Under _Pipeline_ Settings, select the type of agent from the _Agent_ dropdown menu and enter a name for the _Label_.

![image](https://user-images.githubusercontent.com/107522496/216062162-1daa6f27-f9d8-4932-8b23-c3d62585e9dc.png)

---

# 














